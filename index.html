<!DOCTYPE html>
<html>
<head>
    <title>Sanitary Permit Issuance</title>
    <link rel="stylesheet" href="css\2.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .search-container {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            align-items: center;
        }
        .search-container input[type="text"] {
            padding: 8px;
            width: 200px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 5px;
        }
        .search-container button {
            padding: 8px 12px;
            background-color: #4c7b8b;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .top-bar {
            position: relative;
        }
    </style>
</head>
<body>
    <div id="loadingMessage" style="display: none;">Loading data, please wait...</div>
    <div id="errorMessage" style="display: none; color: red;">Failed to load data. Please try again later.</div>
    
    <div class="top-bar">
        <img src="image\My project (1).png" style="width: 90px; height: auto; float: left; margin-left: 2%">
        <img src="image\MUNICIPAL HEALTH OFFICE 2172025 (1).png" style="width: 90px; height: auto; float: left; margin-left: 10px">
        <span>Issuance of Sanitary Permit<kbd></kbd></span>
        <a href="home.html" target="_blank"><img src="image\jhjhj.png" style="width: 40px; height: auto; float: left; margin-left: -17%;
    z-index:100; margin-top:-1%;"></a>
        <div class="search-container">
            <input type="text" id="iframeSearchInput" placeholder="Search...">
            <button id="iframeSearchButton">Search</button>
        </div>
    </div>
    <style>
        .content {
            width: 100vw;
            height: 100vh;
            margin: 0;
            padding: 0;
            overflow: auto;
        }
    </style>
    <div class="content">
        <div class="top-bars">
            <span><kbd></kbd></span>
            <button onclick="window.location.href='add_owner.html'" class="add-button">Add</button> 
        </div>
        <table id="applicationTable" border="1" style="width: 100%; margin-top: 10px; height: 100%;">
            <thead>
                <tr>
                    <th>Business Name</th>
                    <th>Owner/Applicant</th>
                    <th>Applicant Type</th>
                    <th>Application Date</th>
                    <th>Remarks</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="applicationTableBody">
                <tr><td colspan="6">Loading data...</td></tr>
            </tbody>
        </table>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tableBody = document.getElementById('applicationTableBody');
            const searchInput = document.getElementById('iframeSearchInput');
            const searchButton = document.getElementById('iframeSearchButton');

            async function fetchData() {
                try {
                    // Fetch data from backend API connected to PostgreSQL
                    const response = await fetch('http://localhost:3000/api/owners');
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    tableBody.innerHTML = '';
                    data.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td><a href="add_employee.html?business_name=${encodeURIComponent(row.business_name)}&owner_name=${encodeURIComponent(row.owner_name)}">${row.business_name}</a></td>
                            <td>${row.owner_name}</td>
                            <td>${row.applicant_type}</td>
                            <td>${new Date(row.application_date).toLocaleDateString()}</td>
                            <td>${row.remarks}</td>
                            <td>${row.status}</td>
                        `;
                        tableBody.appendChild(tr);
                    });
                } catch (error) {
                    console.error('Error loading data:', error);
                    tableBody.innerHTML = '<tr><td colspan="6">Error loading data.</td></tr>';
                }
            }

            function filterTable() {
                const filter = searchInput.value.toUpperCase();
                const rows = tableBody.getElementsByTagName('tr');
                for (let i = 0; i < rows.length; i++) {
                    const cells = rows[i].getElementsByTagName('td');
                    let found = false;
                    // Only check Business Name (cells[0]) and Owner/Applicant (cells[1])
                    if (cells.length >= 2) {
                        if (cells[0].textContent.toUpperCase().indexOf(filter) > -1 || cells[1].textContent.toUpperCase().indexOf(filter) > -1) {
                            found = true;
                        }
                    }
                    rows[i].style.display = found ? '' : 'none';
                }
            }

            searchButton.addEventListener('click', filterTable);
            searchInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') filterTable();
            });

            fetchData();
        });
    </script>
</body>
</html>
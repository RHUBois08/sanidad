<!DOCTYPE html>
<html>
<head>
    <title>Sanitary Permit Form</title>
    <link rel="stylesheet" href="css\5.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="input-group">
                <label for="businessName">Business Name</label>
                <input type="text" id="businessName">
            </div>
            <div class="input-group">
                <label for="ownerName">Name of Owner/Applicant</label>
                <input type="text" id="ownerName">
            </div>
            <div class="input-group">
                <label for="permitNumber">Sanitary Permit #</label>
                <input type="text" id="permitNumber">
            </div>
        </div>
        <div class="mid-section">
            <label for="classification">Type of Establishment</label><br>
            <input type="text" id="classificationInput"><br><br>
            <label><input type="checkbox" id="categoryFood" name="category" value="Food"> Food</label>
            <label><input type="checkbox" id="categoryNonFood" name="category" value="Non-Food"> Non-Food</label>
        </div>
        <div class="list-header">
            List (202+)
        </div>
        <div class="table-container">
            <table id="table2025" style="display: table;">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Employee Name</th>
                        <th>Address</th>
                        <th>Health Cert. No.</th>
                        <th>Remarks</th>
                        <th>Date of X-ray</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="employeeTableBody2025">
            <tr>
                <td class="employee-no-cell">1</td>
                <td><input type="text" class="employee-name"></td>
                <td><input type="text" class="employee-address"></td>
                <td><input type="text" class="health-cert"></td>
                <td><input type="text" class="remarks"></td>
                <td><input type="date" class="x-ray-date"></td>
                <td><button onclick="removeRow(this)">X</button></td>
            </tr>
                </tbody>
            </table>
            <table id="table2026" style="display:none;">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Employee Name</th>
                        <th>Address</th>
                        <th>Health Cert. No.</th>
                        <th>Remarks</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="employeeTableBody2026">
                    <tr>
                        <td><input type="text" class="employee-no"></td>
                        <td><input type="text" class="employee-name"></td>
                        <td><input type="text" class="employee-address"></td>
                        <td><input type="text" class="health-cert"></td>
                        <td><input type="text" class="remarks"></td>
                        <td><button onclick="removeRow(this)">X</button></td>
                    </tr>
                </tbody>
            </table>
            <table id="table2027" style="display:none;">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Employee Name</th>
                        <th>Address</th>
                        <th>Health Cert. No.</th>
                        <th>Remarks</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="employeeTableBody2027">
                    <tr>
                        <td><input type="text" class="employee-no"></td>
                        <td><input type="text" class="employee-name"></td>
                        <td><input type="text" class="employee-address"></td>
                        <td><input type="text" class="health-cert"></td>
                        <td><input type="text" class="remarks"></td>
                        <td><button onclick="removeRow(this)">X</button></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="submit-section" id="submitSection" style="display: flex; align-items: center;">
            <button class="submit-btn" onclick="submitForm()">Submit</button>
        </div>
    </div>
    <button id="addYearBtn" title="Add Year" style="margin: 10px 0; width: 30px; height: 30px; font-size: 20px; line-height: 20px; padding: 0; border-radius: 50%; background-color: #007bff; color: white; border: none; cursor: pointer;">+</button>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const businessName = urlParams.get('business_name');
            const ownerName = urlParams.get('owner_name');

            if (businessName) {
                document.getElementById('businessName').value = decodeURIComponent(businessName);
            }
            if (ownerName) {
                document.getElementById('ownerName').value = decodeURIComponent(ownerName);
            }

            // Remove localStorage saving for category checkboxes

            // Fetch and prefill Classification and Sanitary Permit #
            if (businessName && ownerName) {
                try {
                    const response = await fetch(`http://localhost:3000/api/classifications?business_name=${encodeURIComponent(businessName)}&owner_name=${encodeURIComponent(ownerName)}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data) {
                            document.getElementById('classificationInput').value = data.classification || '';
                            document.getElementById('permitNumber').value = data.permit_number || '';
                        }
                    }
                } catch (error) {
                    console.error('Error fetching classification data:', error);
                }
            }
        });

        function removeRow(button) {
            button.parentElement.parentElement.remove();
            updateRowNumbers();
        }

        function updateRowNumbers() {
            const visibleTable = document.querySelector(".table-container table:not([style*='display: none'])");
            if (!visibleTable) return;
            const rows = visibleTable.querySelectorAll("tbody tr");
            rows.forEach((row, index) => {
                const noCell = row.querySelector(".employee-no-cell");
                if (noCell) {
                    noCell.textContent = index + 1;
                }
            });
        }

        function submitForm() {
            const businessName = document.getElementById("businessName").value.trim();
            const ownerName = document.getElementById("ownerName").value.trim();
            const permitNumber = document.getElementById("permitNumber").value.trim();
            const classification = document.getElementById("classificationInput").value.trim();

            if (!permitNumber || !classification) {
                alert('Sanitary Permit # and Classification are required.');
                return;
            }

            // Save Sanitary Permit # and Classification with selected categories as linkable_texts
            const selectedCategories = [];
            if (document.getElementById("categoryFood").checked) selectedCategories.push("Food");
            if (document.getElementById("categoryNonFood").checked) selectedCategories.push("Non-Food");

            fetch('http://localhost:3000/api/classifications/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ businessName, ownerName, permitNumber, classification, linkable_texts: selectedCategories }),
            })
            .then(async response => {
                console.log('Server response:', response);
                if (!response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to save Sanitary Permit # and Classification');
                    } else {
                        const errorText = await response.text();
                        console.error('Unexpected response:', errorText);
                        throw new Error('Unexpected response from server');
                    }
                }
                return response.json();
            })
            .then(() => {
                alert('Sanitary Permit # and Classification saved successfully!');
                // Save selected categories in localStorage to persist checkbox state
                localStorage.setItem('selectedCategories', JSON.stringify(selectedCategories));
                // Proceed with saving employees
                saveEmployees();
            })
            .catch(error => {
                console.error('Error saving Sanitary Permit # and Classification:', error);
                alert(`Failed to save Sanitary Permit # and Classification: ${error.message}`);
            });
        }

        // On page load, restore checkbox states from localStorage
        document.addEventListener('DOMContentLoaded', () => {
            const savedCategories = JSON.parse(localStorage.getItem('selectedCategories') || '[]');
            document.getElementById('categoryFood').checked = savedCategories.includes('Food');
            document.getElementById('categoryNonFood').checked = savedCategories.includes('Non-Food');
        });

        function saveEmployees() {
            const categoryFood = document.getElementById("categoryFood").checked;
            const categoryNonFood = document.getElementById("categoryNonFood").checked;
            const categories = [];
            if (categoryFood) categories.push("Food");
            if (categoryNonFood) categories.push("Non-Food");

            const employees = [];
            let visibleTableBody = null;
            if (document.getElementById("table2025").style.display !== "none") {
                visibleTableBody = document.getElementById("employeeTableBody2025");
            } else if (document.getElementById("table2026").style.display !== "none") {
                visibleTableBody = document.getElementById("employeeTableBody2026");
            } else if (document.getElementById("table2027").style.display !== "none") {
                visibleTableBody = document.getElementById("employeeTableBody2027");
            } else {
                visibleTableBody = document.getElementById("employeeTableBody");
            }

            visibleTableBody.querySelectorAll("tr").forEach(row => {
                const no = row.querySelector(".employee-no").value;
                const name = row.querySelector(".employee-name").value;
                const address = row.querySelector(".employee-address").value;
                const cert = row.querySelector(".health-cert").value;
                const remarks = row.querySelector(".remarks").value;
                employees.push({ no, name, address, cert, remarks });
            });

            const formData = { businessName, ownerName, categories, employees };

            fetch('http://localhost:3000/api/employees/full', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData),
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to save employees');
                alert('Employees saved successfully!');
            })
            .catch(error => {
                console.error('Error saving employees:', error);
                alert('Failed to save employees.');
            });
        }

        document.getElementById("year2025Btn").addEventListener("click", () => {
            showYearTable("2025");
        });
        document.getElementById("year2026Btn").addEventListener("click", () => {
            showYearTable("2026");
        });
        document.getElementById("year2027Btn").addEventListener("click", () => {
            showYearTable("2027");
        });

        // Add event listeners for remove year buttons
        document.querySelectorAll(".remove-year-btn").forEach(btn => {
            btn.addEventListener("click", (e) => {
                const year = e.target.getAttribute("data-year");
                removeYear(year);
            });
        });

        document.getElementById("addYearBtn").addEventListener("click", () => {
            // Find all year buttons and get the max year
            const yearButtons = Array.from(document.querySelectorAll(".year-btn"));
            let maxYear = 2027; // default starting max year
            yearButtons.forEach(btn => {
                const yearNum = parseInt(btn.textContent);
                if (!isNaN(yearNum) && yearNum > maxYear) {
                    maxYear = yearNum;
                }
            });
            const nextYear = (maxYear + 1).toString();
            addYear(nextYear);
        });

        function showYearTable(year) {
            const years = ["2025", "2026", "2027"];
            // Add dynamically added years to the list
            const dynamicYears = Array.from(document.querySelectorAll(".year-btn")).map(btn => btn.textContent);
            const allYears = years.concat(dynamicYears);

            allYears.forEach(y => {
                const table = document.getElementById("table" + y);
                if (table) {
                    table.style.display = (y === year) ? "table" : "none";
                }
            });
        }

        function addYear(year) {
            // Check if year button already exists
            if (document.getElementById("year" + year + "Btn")) {
                alert("Year " + year + " already exists.");
                return;
            }

            // Create new year button
            const newBtn = document.createElement("button");
            newBtn.id = "year" + year + "Btn";
            newBtn.textContent = year;
            newBtn.className = "year-btn";
            newBtn.style.marginLeft = "10px";
            newBtn.addEventListener("click", () => {
                showYearTable(year);
            });

            // Append new button to submit section
            document.getElementById("submitSection").appendChild(newBtn);

            // Create new table for the year
            const tableContainer = document.querySelector(".table-container");
            const newTable = document.createElement("table");
            newTable.id = "table" + year;
            newTable.style.display = "none";

            newTable.innerHTML = `
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Employee Name</th>
                        <th>Address</th>
                        <th>Health Cert. No.</th>
                        <th>Remarks</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="employeeTableBody${year}">
                    <tr>
                        <td><input type="text" class="employee-no"></td>
                        <td><input type="text" class="employee-name"></td>
                        <td><input type="text" class="employee-address"></td>
                        <td><input type="text" class="health-cert"></td>
                        <td><input type="text" class="remarks"></td>
                        <td><button onclick="removeRow(this)">X</button></td>
                    </tr>
                </tbody>
            `;

            tableContainer.appendChild(newTable);
        }
    </script>
    <script src="style.js"></script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <title>Sanitary Permit Form</title>
    <link rel="stylesheet" href="css\5.css">
    <link rel="icon" href="assets\sanidad_logo.png" type="image/png">
    <script>
        let isClientConnected = false; // Track connection status
        let connectionReadyCallbacks = []; // Queue for functions waiting for connection

        const client = new window.pg.Client({
            user: 'postgres',
            host: 'localhost',
            database: 'sanitary_permits_db',
            password: 'passsword',
            port: 5432,
        });

        client.connect()
            .then(() => {
                console.log('Connected to the database');
                isClientConnected = true; // Mark client as connected
                connectionReadyCallbacks.forEach(callback => callback()); // Execute queued callbacks
                connectionReadyCallbacks = []; // Clear the queue
                document.getElementById('connectionStatus').textContent = 'Database connected'; // Update status
                document.getElementById('connectionStatus').style.color = 'green';
                document.getElementById('print-permit').disabled = false; // Enable the button
            })
            .catch((err) => {
                console.error('Error connecting to the database', err.stack);
                document.getElementById('connectionStatus').textContent = 'Database connection failed'; // Update status
                document.getElementById('connectionStatus').style.color = 'red';
            });

        function safeGenerateSanitaryPermit() {
            if (!isClientConnected) {
                console.warn('Database client is not connected yet. Queuing the request.');
                connectionReadyCallbacks.push(() => {
                    console.log('Executing queued request after connection.');
                    generate_sanitary_permit();
                }); // Queue the function
                return;
            }
            generate_sanitary_permit();
        }

        function generate_sanitary_permit() {
            const business = "Papa P Massage Parlor";

            client.query('SELECT owner_name FROM owners WHERE business_name = $1', [business])
                .then((res) => {
                    if (res.rows.length > 0) {
                        console.log('Data Fetched: ', res.rows[0].owner_name);
                    } else {
                        console.log('No user found with that name.');
                    }
                })
                .catch((err) => {
                    console.error('Error executing query', err.stack);
                });
        }

        // Attach the function to the global scope
        window.safeGenerateSanitaryPermit = safeGenerateSanitaryPermit;
    </script>
</head>
<body>
    <div class="container">
        <div id="connectionStatus" style="margin-bottom: 10px; font-weight: bold;">Connecting to database...</div>
          <div class="top-bar">
            <a href="index.html"><img src="image\jhjhj.png" style="width: 40px; height: auto; float: left; margin-left:-40px;
    z-index:100; margin-top:-2%;"></a>
        <div class="header">
            <div class="input-group" style="margin-left: 50px;">
                <label for="businessName">Business Name</label>
                <input style="height: 20px; "type="text" id="businessName">
            </div>
            <div class="input-group" style="margin-left: 10px;">
                <label for="ownerName">Name of Owner/Applicant</label>
                <input style="height: 20px; " type="text" id="ownerName">
            </div>
            <div class="input-group" style="margin-right: 50px;">
                <label for="permitNumber">Sanitary Permit #</label>
                <input style="height: 20px; " type="text" id="permitNumber">
            </div>
            <div style="margin-top: 70px; margin-left: 505px; position: absolute; ">
                <label for="classification" style="margin-right: 55px; margin-top: -30px;">Type of Establishment</label><br>
                <input style=" width: 239px; height: 20px;" type="text" id="classificationInput">
        </div>
        </div>
        <div class="mid-section" style="margin-top: 10px; position: absolute; margin-left: 50px;">
            <label><input type="radio" id="categoryFood" name="category" value="Food"> Food</label>
            <label><input type="radio" id="categoryNonFood" name="category" value="Non-Food"> Non-Food</label>
<button id="print-permit" style="margin-left: 1115px; width: 60px; position: absolute; margin-top: 55px; height:30px; border-radius: 5px; border: none;" onclick="generate_sanitary_permit()" aria-label="Print" title="Print">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
        <path d="M2 7a1 1 0 0 0-1 1v4a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-4a1 1 0 0 0-1-1H2zm11 1v3H3v-3h10zM5 10h6v1H5v-1zM4 1h8a1 1 0 0 1 1 1v3H3V2a1 1 0 0 1 1-1zM3 5h10v1H3V5z"/>
    </svg>
</button>
        </div>
        </div>
        <div class="table-container">
        </div>
        <div class="submit-section" id="submitSection" style="display: flex; align-items: center; margin-top: 10px; position:absolute; margin-left:10px; z-index: 10; justify-content: space-between; width: calc(100% - 100px);">
    <div style="display: flex;">
        <button id="addYearBtn" style="border-radius: 4px; color: black; border-color:rgba(53, 45, 45, 0.712); cursor: pointer; position: relative; margin-left: 10px;">+</button>
    </div>

    <div style="display: flex; margin-left: 20px;">
        <button class="submit-btn" onclick="submitForm()" aria-label="Save" title="Save" style="margin-right: 5px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M7 10.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5zm-3-7A1.5 1.5 0 0 0 2.5 5v6A1.5 1.5 0 0 0 4 12.5h8a1.5 1.5 0 0 0 1.5-1.5V5A1.5 0 0 0 12 3.5H4zm0 1h8a.5.5 0 0 1 .5.5v1H3.5v-1a.5.5 0 0 1 .5-.5zM3 8h10v3.5a.5.5 0 0 1-.5.5H3.5a.5.5 0 0 1-.5-.5V8z"/>
        </svg>
    </button>
    <button id="submitEmployeesBtn" onclick="saveEmployees()" aria-label="Submit" title="Submit" style="margin-right: 5px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="24" fill="currentColor" viewBox="0 0 16 16">
            <path d="M15.854 0.146a.5.5 0 0 0-.707 0L1 14.293V9.5a.5.5 0 0 0-1 0v5a.5.5 0 0 0 .5.5h5a.5.5 0 0 0 0-1H1.707l14.147-14.147a.5.5 0 0 0 0-.707z"/>
        </svg>
    </button>
    <button id="printSaveBtn" onclick="printForm()" aria-label="Print" title="Print" style="margin-right: -80px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="24" fill="currentColor" viewBox="0 0 16 16">
            <path d="M2 7a1 1 0 0 0-1 1v4a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-4a1 1 0 0 0-1-1H2zm11 1v3H3v-3h10zM5 10h6v1H5v-1zM4 1h8a1 1 0 0 1 1 1v3H3V2a1 1 0 0 1 1-1zM3 5h10v1H3V5z"/>
        </svg>
    </button>
</div>
</div>
    <!-- Removed the Add Year button as per user request -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Add this near the beginning of the DOMContentLoaded event
            try {
                const response = await fetch('http://localhost:3000/api/years');
                if (response.ok) {
                    const years = await response.json();
                    years.forEach(yearObj => {
                        if (yearObj.year !== 2025) { // Skip 2025 as it's the default
                            addYear(yearObj.year, false);
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading years:', error);
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            const businessName = urlParams.get('business_name');
            const ownerName = urlParams.get('owner_name');

            if (businessName) {
                document.getElementById('businessName').value = decodeURIComponent(businessName);
            }
            if (ownerName) {
                document.getElementById('ownerName').value = decodeURIComponent(ownerName);
            }

            // Remove localStorage saving for category checkboxes

            // Fetch and prefill Classification and Sanitary Permit #
            if (businessName && ownerName) {
                try {
                    const response = await fetch(`http://localhost:3000/api/classifications?business_name=${encodeURIComponent(businessName)}&owner_name=${encodeURIComponent(ownerName)}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data) {
                            document.getElementById('classificationInput').value = data.classification || '';
                            document.getElementById('permitNumber').value = data.permit_number || '';
                            // Restore radio button selection from categories
                            if (data.categories && Array.isArray(data.categories)) {
                                document.getElementById('categoryFood').checked = data.categories.includes('Food');
                                document.getElementById('categoryNonFood').checked = data.categories.includes('Non-Food');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error fetching classification data:', error);
                }

        // Fetch and populate employees data
        try {
            const empResponse = await fetch(`http://localhost:3000/api/employees?business_name=${encodeURIComponent(businessName)}&owner_name=${encodeURIComponent(ownerName)}`);
            if (empResponse.ok) {
                const employees = await empResponse.json();
                if (Array.isArray(employees) && employees.length > 0) {
                    populateEmployeeTable(employees);
                } 
                
                else {
                    // Clear table and add a single empty row with input boxes for new data entry
                    const tbody = document.getElementById("employeeTableBody2025");
                    tbody.innerHTML = `
                        <tr>
                    <td class="employee-no-cell">1</td>
                    <td><input type="text" class="employee-name" required></td>
                    <td><input type="text" class="employee-address" required></td>
                    <td><input type="text" class="health-cert" required></td>
                    <td><input type="text" class="remarks" required></td>
                    <td><input type="date" class="x-ray-date" required></td>
                    <td>
                        <button onclick="addRow()" aria-label="Add" title="Add" style="background:none; border:none; cursor:pointer; padding:0;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                        </button>
                        <button onclick="removeRow(this)" aria-label="Delete" title="Delete" style="background:none; border:none; cursor:pointer; padding:0;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M5.5 5.5a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5zm5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5z"/>
                                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1 0-2h3.086a1 1 0 0 1 .707.293l.707.707h3.586l.707-.707A1 1 0 0 1 11.414 1H14.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118z"/>
                        </svg>
                        </button>
                    </td>
                </tr>
            `;
                }
            } 
            
            else {
                console.error('Failed to fetch employees data. Status:', empResponse.status);
                alert('Failed to fetch employees data from server.');
            }
        } 
        
        catch (error) {
            console.error('Error fetching employees data:', error);
            alert('Error fetching employees data. Please try again later.');
        }
            }
        });

        function removeRow(button) {
            button.parentElement.parentElement.remove();
            updateRowNumbers();
        }

        function populateEmployeeTable(employees, unsavedRows = []) {
            // Get the currently visible table or the first available table
            const visibleTable = document.querySelector(".table-container table:not([style*='display: none'])") || 
                                document.querySelector(".table-container table");
            
            if (!visibleTable) {
                console.error('No table found in the container');
                return;
            }

            const visibleTableBody = visibleTable.querySelector('tbody');
            if (!visibleTableBody) {
                console.error('No tbody found in the table');
                return;
            }

            // Clear existing rows
            visibleTableBody.innerHTML = '';

            // Populate rows from DB (saved)
            employees.forEach((emp, index) => {
                const tr = document.createElement('tr');
                // No.
                const tdNo = document.createElement('td');
                tdNo.className = 'employee-no-cell';
                tdNo.textContent = emp.no || (index + 1);
                tr.appendChild(tdNo);

                // Employee Name
                const tdName = document.createElement('td');
                const inputName = document.createElement('input');
                inputName.type = 'text';
                inputName.className = 'employee-name';
                inputName.value = emp.employee_name || '';
                tdName.appendChild(inputName);
                tr.appendChild(tdName);

                // Address
                const tdAddress = document.createElement('td');
                const inputAddress = document.createElement('input');
                inputAddress.type = 'text';
                inputAddress.className = 'employee-address';
                inputAddress.value = emp.address || '';
                tdAddress.appendChild(inputAddress);
                tr.appendChild(tdAddress);

                // Health Cert No.
                const tdCert = document.createElement('td');
                const inputCert = document.createElement('input');
                inputCert.type = 'text';
                inputCert.className = 'health-cert';
                inputCert.value = emp.health_cert_no || '';
                tdCert.appendChild(inputCert);
                tr.appendChild(tdCert);

                // Remarks
                const tdRemarks = document.createElement('td');
                const inputRemarks = document.createElement('input');
                inputRemarks.type = 'text';
                inputRemarks.className = 'remarks';
                inputRemarks.value = emp.remarks || '';
                tdRemarks.appendChild(inputRemarks);
                tr.appendChild(tdRemarks);

                // Date of X-ray
                const tdXray = document.createElement('td');
                const inputXray = document.createElement('input');
                inputXray.type = 'date';
                inputXray.className = 'x-ray-date';
                if (emp.date_of_xray) {
                    inputXray.value = emp.date_of_xray.split('T')[0];
                }
                tdXray.appendChild(inputXray);
                tr.appendChild(tdXray);

                // Actions
                const tdActions = document.createElement('td');
                tdActions.innerHTML = `
                    <button onclick="addRow()" aria-label="Add" title="Add" style="background:none; border:none; cursor:pointer; padding:0;color:black;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                    </button>
                    <button onclick="removeRow(this)" aria-label="Delete" title="Delete" style="background:none; border:none; cursor:pointer; padding:0; margin-left: 5px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M5.5 5.5a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5zm5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5z"/>
                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1 0-2h3.086a1 1 0 0 1 .707.293l.707.707h3.586l.707-.707A1 1 0 0 1 11.414 1H14.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118z"/>
                        </svg>
                    </button>
                `;
                tr.appendChild(tdActions);

                visibleTableBody.appendChild(tr);
            });

            // Append unsaved/new rows (if any)
            unsavedRows.forEach(rowData => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="employee-no-cell"></td>
                    <td><input type="text" class="employee-name" required value="${rowData.name || ''}"></td>
                    <td><input type="text" class="employee-address" required value="${rowData.address || ''}"></td>
                    <td><input type="text" class="health-cert" required value="${rowData.cert || ''}"></td>
                    <td><input type="text" class="remarks" required value="${rowData.remarks || ''}"></td>
                    <td><input type="date" class="x-ray-date" required value="${rowData.date_of_xray || ''}"></td>
                <td>
                    <button onclick="addRow()">+</button>
                    <button onclick="removeRow(this)" aria-label="Delete" title="Delete" style="background:none; border:none; cursor:pointer; padding:0; font-size:20px; margin-left: 5px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M5.5 5.5a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5zm5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5z"/>
                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1 0-2h3.086a1 1 0 0 1 .707.293l.707.707h3.586l.707-.707A1 1 0 0 1 11.414 1H14.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118z"/>
                        </svg>
                    </button>
                </td>
            `;
                visibleTableBody.appendChild(tr);
            });

            // If no rows at all, add a blank row
            if (employees.length === 0 && unsavedRows.length === 0) {
                addRow();
            }

            updateRowNumbers();
        }

        function printForm() {
            window.print();
        }

        function updateRowNumbers() {
            const visibleTable = document.querySelector(".table-container table:not([style*='display: none'])");
            if (!visibleTable) return;
            const rows = visibleTable.querySelectorAll("tbody tr");
            rows.forEach((row, index) => {
                const noCell = row.querySelector(".employee-no-cell");
                if (noCell) {
                    noCell.textContent = index + 1;
                }
            });
        }

        async function submitForm() {
            const businessName = document.getElementById("businessName").value.trim();
            const ownerName = document.getElementById("ownerName").value.trim();
            const permitNumber = document.getElementById("permitNumber").value.trim();
            const classification = document.getElementById("classificationInput").value.trim();

            if (!permitNumber || !classification) {
                alert('Successfully Saved');
                return;
            }

            // Validate required inputs in employee table
            const visibleTableBody = document.querySelector(".table-container table:not([style*='display: none']) tbody");
            if (visibleTableBody) {
                const inputs = visibleTableBody.querySelectorAll("input[required]");
                for (const input of inputs) {
                    if (!input.value.trim()) {
                        alert("Please input all the required fields in the employee table.");
                        input.focus();
                        return;
                    }
                }
            }

            // Save Sanitary Permit # and Classification with selected categories as linkable_texts
            const selectedCategories = [];
            if (document.getElementById("categoryFood").checked) selectedCategories.push("Food");
            if (document.getElementById("categoryNonFood").checked) selectedCategories.push("Non-Food");

            try {
                const response = await fetch('http://localhost:3000/api/classifications/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ businessName, ownerName, permitNumber, classification, linkable_texts: selectedCategories }),
                });

                if (!response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to save Sanitary Permit # and Classification');
                    } else {
                        const errorText = await response.text();
                        console.error('Unexpected response:', errorText);
                        throw new Error('Unexpected response from server');
                    }
                }

                alert('Saved successfully!');
                // Save selected categories in localStorage to persist checkbox state
                localStorage.setItem('selectedCategories', JSON.stringify(selectedCategories));
                // Proceed with saving employees
                // await saveEmployees();
            } catch (error) {
                console.error('Error saving Sanitary Permit # and Classification:', error);
                alert(`Failed to save Sanitary Permit # and Classification: ${error.message}`);
            }
        }

        // On page load, restore checkbox states from localStorage
        document.addEventListener('DOMContentLoaded', () => {
            const savedCategories = JSON.parse(localStorage.getItem('selectedCategories') || '[]');
            document.getElementById('categoryFood').checked = savedCategories.includes('Food');
            document.getElementById('categoryNonFood').checked = savedCategories.includes('Non-Food');
        });

        async function saveEmployees() {
            const businessName = document.getElementById("businessName").value.trim();
            const ownerName = document.getElementById("ownerName").value.trim();
            const categoryFood = document.getElementById("categoryFood").checked;
            const categoryNonFood = document.getElementById("categoryNonFood").checked;
            const categories = [];
            if (categoryFood) categories.push("Food");
            if (categoryNonFood) categories.push("Non-Food");

            let visibleTableBody = null;
            const table2025 = document.getElementById("table2025");
            const table2026 = document.getElementById("table2026");
            const table2027 = document.getElementById("table2027");

            if (table2025 && table2025.offsetParent !== null) {
                visibleTableBody = document.getElementById("employeeTableBody2025");
            } else if (table2026 && table2026.offsetParent !== null) {
                visibleTableBody = document.getElementById("employeeTableBody2026");
            } else if (table2027 && table2027.offsetParent !== null) {
                visibleTableBody = document.getElementById("employeeTableBody2027");
            } else {
                visibleTableBody = document.getElementById("employeeTableBody2025");
            }

            if (!visibleTableBody) {
                alert('No employee table is visible. Cannot save employees.');
                return;
            }

            // Validate required inputs in employee table before saving
            const inputs = visibleTableBody.querySelectorAll("input[required]");
            for (const input of inputs) {
                if (!input.value.trim()) {
                    alert("Please input all the required fields in the employee table.");
                    input.focus();
                    return;
                }
            }

            // Gather all rows (including unsaved/new)
            const employees = [];
            visibleTableBody.querySelectorAll("tr").forEach(row => {
                const no = row.querySelector(".employee-no-cell")?.textContent.trim() || '';
                const name = row.querySelector(".employee-name")?.value.trim() || '';
                const address = row.querySelector(".employee-address")?.value.trim() || '';
                const cert = row.querySelector(".health-cert")?.value.trim() || '';
                const remarks = row.querySelector(".remarks")?.value.trim() || '';
                let date_of_xray = row.querySelector(".x-ray-date")?.value || '';
                if (date_of_xray === "") date_of_xray = null;
                // Only push if at least one field is filled
                if (name || address || cert || remarks || date_of_xray) {
                    employees.push({
                        business_name: businessName,
                        owner_name: ownerName,
                        year: visibleTableBody.id.replace('employeeTable', ''),
                        no,
                        name,
                        address,
                        cert,
                        remarks,
                        date_of_xray
                    });
                }
            });

            const formData = { businessName, ownerName, categories, employees };

            try {
                const response = await fetch('http://localhost:3000/api/employees/full', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to save employees. Status: ${response.status}. Response: ${errorText}`);
                }

                alert('Employees saved successfully!');
                // After saving, reload all employees using only backend data (no unsaved rows)
                await reloadEmployeesTableOnlyFromBackend(businessName, ownerName, visibleTableBody);
            } catch (error) {
                console.error('Error saving employees:', error);
                alert(`Failed to save employees: ${error.message}`);
            }
        }

        async function reloadEmployeesTableOnlyFromBackend(businessName, ownerName, visibleTableBody) {
            try {
                if (!visibleTableBody) {
                    console.error('No table body provided');
                    return;
                }

                const year = visibleTableBody.id.replace('employeeTableBody', '');
                const empResponse = await fetch(
                    `http://localhost:3000/api/employees?` + 
                    `business_name=${encodeURIComponent(businessName)}&` +
                    `owner_name=${encodeURIComponent(ownerName)}&` +
                    `year=${year}`
                );

                if (!empResponse.ok) {
                    const errorData = await empResponse.json();
                    throw new Error(errorData.error || 'Failed to fetch employees');
                }

                const employees = await empResponse.json();
                populateEmployeeTable(employees, []); // do not append unsaved rows
            } catch (error) {
                console.error('Error fetching employees data:', error);
                alert('Failed to load employee data: ' + (error.message || 'Unknown error occurred'));
            }
        }
        document.getElementById("year2025Btn").addEventListener("click", () => {
            showYearTable("2025");
        });
        document.getElementById("year2026Btn").addEventListener("click", () => {
            showYearTable("2026");
        });
        document.getElementById("year2027Btn").addEventListener("click", () => {
            showYearTable("2027");
        });

        // Add event listeners for remove year buttons
        document.querySelectorAll(".remove-year-btn").forEach(btn => {
            btn.addEventListener("click", (e) => {
                const year = e.target.getAttribute("data-year");
                removeYear(year);
            });
        });

        function showYearTable(year) {
            const tables = document.querySelectorAll(".table-container table");
            tables.forEach(table => {
                table.style.display = table.id === "table" + year ? "table" : "none";
            });
        }

        function createYearUI(year) {
    // Create container with relative positioning
    const buttonContainer = document.createElement("div");
    buttonContainer.style.display = "inline-block";
    buttonContainer.style.position = "relative";
    buttonContainer.style.marginLeft = "10px";

    // Create year button
    const newBtn = document.createElement("button");
    newBtn.id = "year" + year + "Btn";
    newBtn.textContent = year;
    newBtn.className = "year-btn";
    newBtn.style.color = "black";
    newBtn.style.borderRadius = "4px";
    newBtn.style.cursor = "pointer";
    newBtn.style.borderColor = "rgba(0, 0, 0, 0.712)";
    newBtn.style.paddingRight = "20px"; // Make space for remove button
    newBtn.addEventListener("click", () => {
        showYearTable(year);
    });

    // Create remove button with absolute positioning
    const removeBtn = document.createElement("button");
    removeBtn.innerHTML = "Ã—";
    removeBtn.style.position = "absolute";
    removeBtn.style.right = "2px";
    removeBtn.style.top = "50%";
    removeBtn.style.transform = "translateY(-50%)";
    removeBtn.style.color = "red";
    removeBtn.style.border = "none";
    removeBtn.style.background = "none";
    removeBtn.style.cursor = "pointer";
    removeBtn.style.fontSize = "16px";
    removeBtn.style.padding = "0";
    removeBtn.style.lineHeight = "1";
    removeBtn.title = "Remove year";
    removeBtn.addEventListener("click", (e) => {
        e.stopPropagation(); // Prevent year button click
        removeYear(year);
    });

    // Add buttons to container
    buttonContainer.appendChild(newBtn);
    buttonContainer.appendChild(removeBtn);

    // Add container to page
    const submitSection = document.getElementById("submitSection").querySelector("div:first-child");
    const addYearBtn = document.getElementById("addYearBtn");
    submitSection.insertBefore(buttonContainer, addYearBtn);

    // Create table for the year
    const tableContainer = document.querySelector(".table-container");
    const newTable = document.createElement("table");
    newTable.id = "table" + year;
    newTable.style.display = "none";
    
    newTable.innerHTML = `
        <thead>
            <tr>
                <th>No.</th>
                <th>Employee Name</th>
                <th>Address</th>
                <th>Health Cert. No.</th>
                <th>Remarks</th>
                <th>Date of X-ray</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="employeeTableBody${year}">
            <tr>
                <td class="employee-no-cell">1</td>
                <td><input type="text" class="employee-name" required></td>
                <td><input type="text" class="employee-address" required></td>
                <td><input type="text" class="health-cert" required></td>
                <td><input type="text" class="remarks" required></td>
                <td><input type="date" class="x-ray-date" required></td>
                <td>
                    <button onclick="addRow()" aria-label="Add" title="Add" style="background:none; border:none; cursor:pointer; padding:0;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                        </svg>
                    </button>
                    <button onclick="removeRow(this)" aria-label="Delete" title="Delete" style="background:none; border:none; cursor:pointer; padding:0; margin-left: 5px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M5.5 5.5a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5zm5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5z"/>
                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1 0-2h3.086a1 1 0 0 1 .707.293l.707.707h3.586l.707-.707A1 1 0 0 1 11.414 1H14.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118z"/>
                        </svg>
                    </button>
                </td>
            </tr>
        </tbody>
    `;

    tableContainer.appendChild(newTable);
}

        function addYear(year, saveToDb = true) {
            const yearNum = parseInt(year);
            if (!year || isNaN(yearNum)) {
                alert("Please enter a valid year");
                return;
            }

            if (document.getElementById("year" + year + "Btn")) {
                alert("Year " + year + " already exists.");
                return;
            }

            if (saveToDb) {
                fetch('http://localhost:3000/api/years/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ year: yearNum })
                })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to save year');
                    return response.json();
                })
                .then(data => {
                    if (data.added) {
                        createYearUI(year);
                        console.log('Year added successfully');
                    } else {
                        console.log('Year already exists in database');
                    }
                })
                .catch(error => {
                    console.error('Error saving year:', error);
                    alert('Failed to save year to database: ' + error.message);
                });
            } else {
                createYearUI(year);
            }
        }

        function removeYear(year) {
            if (!confirm("Are you sure you want to remove the year " + year + "? This will delete all employee data for this year.")) {
                return;
            }

            fetch(`http://localhost:3000/api/years/${year}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to remove year');
                }
                // Remove UI elements
                const table = document.getElementById("table" + year);
                if (table) table.remove();
                
                const yearBtn = document.getElementById("year" + year + "Btn");
                if (yearBtn) {
                    const container = yearBtn.parentElement;
                    if (container) {
                        container.remove();
                    }
                }
                
                // Show another year table if available
                const firstTable = document.querySelector(".table-container table");
                if (firstTable) {
                    const firstYear = firstTable.id.replace("table", "");
                    showYearTable(firstYear);
                }
            })
            .catch(error => {
                console.error('Error removing year:', error);
                alert('Failed to remove year and associated data');
            });
        }

        // Removed the duplicate removeYear function since it's no longer needed
        // ...existing code...
        function addRow() {
            const tableBody = document.querySelector(".table-container table:not([style*='display: none']) tbody");
            if (!tableBody) return;

            const newRow = document.createElement("tr");
                newRow.innerHTML = `
                <td class="employee-no-cell"></td>
                <td><input type="text" class="employee-name" required></td>
                <td><input type="text" class="employee-address" required></td>
                <td><input type="text" class="health-cert" required></td>
                <td><input type="text" class="remarks" required></td>
                <td><input type="date" class="x-ray-date" required></td>
                <td>
                    <button onclick="addRow()" aria-label="Add" title="Add" style="background:none; border:none; cursor:pointer; padding:0;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                        </svg>
                    </button>
                    <button onclick="removeRow(this)" aria-label="Delete" title="Delete" style="background:none; border:none; cursor:pointer; padding:0; margin-left: 5px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M5.5 5.5a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5zm5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5z"/>
                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1 0-2h3.086a1 1 0 0 1 .707.293l.707.707h3.586l.707-.707A1 1 0 0 1 11.414 1H14.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118z"/>
                        </svg>
                    </button>
                </td>
            `;
            tableBody.appendChild(newRow);
            updateRowNumbers();
        }
    </script>
    <script src="print.js"></script>
</body>
</html>
<script>
        document.getElementById("addYearBtn").addEventListener("click", () => {
            const year = prompt("Enter a year to add:");
            if (year) {
                addYear(year);
            }
        });
    </script>

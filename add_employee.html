<!-- add_employee.html -->

<!DOCTYPE html>
<html>
<head>
    <title>Sanitary Permit Form</title>
    <link rel="stylesheet" href="css\5.css">
    <link rel="icon" href="image\sanidad_logo.png" type="image/png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.0/mammoth.browser.min.js"></script>
</head>
<body>
    <div class="container">
        <div id="connectionStatus" style="margin-bottom: 10px; font-weight: bold;">Connecting to database...</div>
          <div class="top-bar">
           <a href="home.html" class="home-link">
            <img src="image\jhjhj.png" alt="Home">
        </a>
        <div class="header">
            <div class="input-group">
                <label for="businessName" style="margin-left: 50px;">Business Name</label>
                <input style="height: 20px; width: 115%; "type="text" id="businessName">
            </div>
            <div class="input-group" style="margin-left: -45px;">
                <label for="ownerName"style="margin-left: 54px;">Name of Owner/Applicant</label>
                <input style="height: 20px; width: 115%;" type="text" id="ownerName">
            </div>
            <div class="input-group-2" style="margin-top: 5px; margin-left:1020px;position: fixed;" required="">
                <label id="permitLabel" for="permitStatus" style="margin-right: 170px; top: 36px; position: fixed;">Sanitary Permit No.</label>
                <input style="height: 20px; width: 180px;" type="text" id="permitNumber">
            </div>
            <td>
                <label for="permitStatus" style="margin-top: 65px; margin-right:138px;">Status</label>
                <select id="permitStatus" class="employee-sex" style="width:200px;position:absolute; height:39px;
                margin-top: 89px; border-radius: 5px; margin-left: 1020px;" required>
                    <option value="">Select Status</option>
                    <option value="Denied">Denied</option>
                    <option value="For Release">For Release</option>
                    <option value="Issued">Issued</option>
                    <option value="Pending">Pending</option>
                </select>
            </td>
            <div style="margin-top: 65px; margin-left:600px; position: absolute; "required>
                <label for="classification" style="margin-right: 70px;">Type of Establishment</label><br>
                <input list="classificationOptions" id="classificationInput" style="width: 279px; height: 20px; margin-left: -50px; margin-top: 5px;
                padding: 8px; border: 1px solid #ccc; border-radius: 4px; appearance: none; -webkit-appearance: none; background-color: white; ">
                <datalist id="classificationOptions">
                    <option value="Apartment">
                    <option value="Bakery">
                    <option value="Barber Shop">
                    <option value="Battery Supply">
                    <option value="Beauty Lounge">
                    <option value="Carton Supply">
                    <option value="Catering Services">
                    <option value="Clothing Shop">
                    <option value="Cockpit">
                    <option value="Coffee Shop">
                    <option value="Dental Clinic">
                    <option value="Flower Shop">
                    <option value="Food Manufacturing">
                    <option value="Food Stall">
                    <option value="Furniture Shop">
                    <option value="Gasoline Station">
                    <option value="Glass & Aluminum Services">
                    <option value="Grocery Store">
                    <option value="Jewelry Shop">
                    <option value="Junk Shop Salon">
                    <option value="Laundry Shop">
                    <option value="Lights and Sound Services">
                    <option value="Market Stall">
                    <option value="Mini Grocery">
                    <option value="Motor Shop">
                    <option value="Nail Salon">
                    <option value="Pharmacy">
                    <option value="Printing Shop">
                    <option value="Repair Shop">
                    <option value="Resort">
                    <option value="Restaurant">
                    <option value="Retail Trade">
                    <option value="Rice Mill">
                    <option value="Rice Trading">
                    <option value="Spa">
                    <option value="Space Rental">
                    <option value="Tattoo Shop">
                    <option value="Trucking Services">
                    <option value="Vape Shop">
                    <option value="Water Refilling Station">
                </datalist>
            </div>
        </div>
        <input type="hidden" id="classificationId">
        <div class="mid-section" style="margin-top: -5px; position: absolute; margin-left: 45px;">
            <label><input type="radio" id="categoryFood" name="category" value="Food"> Food</label>
            <label><input type="radio" id="categoryNonFood" name="category" value="Non-Food"> Non-Food</label>

        </div>
        </div>
        <div class="table-container">
            <table id="table2025" style="display: table;">
                <thead>
                    <tr>
                        <th>No.</th>
                        <th>Employee Name</th>
                        <th>Position</th>
                        <th>Age</th>
                        <th>Sex</th>
                        <th>Nationality</th>
                        <th>Place of Work</th>
                        <th>Address</th>
                        <th>Health Cert. No.</th>
                        <th>Remarks</th>
                        <th>Date of X-ray</th>
                        <th>Actions</th>
                    </tr>
                </thead>
            <tbody id="employeeTableBody2025">
            <tr>
                    <td class="employee-no-cell">1</td>
                    <td><input type="text" class="employee-name" required></td>
                    <td><input type="text" class="employee-position" required></td>
                    <td><input type="number" class="employee-age" required></td>
                    <td><select class="employee-sex" required>
                        <option value="">Select Sex</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        </select></td>
                    <td><input type="text" class="employee-nationality" required></td>
                    <td><input type="text" class="employee-place-of-work" required></td>
                    <td><input type="text" class="employee-address" required></td>
                    <td><input type="text" class="health-cert" required></td>
                    <td><input type="text" class="remarks" required></td>
                    <td><input type="date" class="x-ray-date" required></td>
                    <td>
                    <button id="print-health-card" onclick="generate_health_cert()" aria-label="Print" title="Print Health Card">
                        <img src="image/health_card_print_icon.png" alt="Print" style="background: #0047abc9; border-radius: 50%; border:none; cursor:pointer; width: 24px; height: 24px; padding: 0; display: inline-flex; align-items: center; justify-content: center;">
                    </button>
                    <button onclick="addRow()" aria-label="Add" title="Add" style="background: #0047abc9; border-radius: 50%; border:none; cursor:pointer; width: 24px; height: 24px; padding: 0; display: inline-flex; align-items: center; justify-content: center;"
                    onmouseover="this.style.backgroundColor='#002e63'"
                    onmouseout="this.style.backgroundColor='#0047abc9'">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path fill="white" d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                            </svg>
                    </button>
                    <button onclick="removeRow(this)" aria-label="Delete" title="Delete" style="background:  #ff4d4d; border-radius: 50%; border:none; cursor:pointer;  width: 24px; height: 24px; padding: 0; margin-left: 5px; display: inline-flex; align-items: center; justify-content: center;"
                    onmouseover="this.style.backgroundColor='#cc0000'"
                    onmouseout="this.style.backgroundColor='#ff4d4d'">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M5.5 5.5a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5zm5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5z"/>
                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1 0-2h3.086a1 1 0 0 1 .707.293l.707.707h3.586l.707-.707A1 1 0 0 1 11.414 1H14.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118z"/>
                        </svg>
                    </button>
                </td>
            </tr>
            </tr>
                </tbody>
            </table>
        </div>
            <div class="submit-section" id="submitSection" style="display: flex; align-items: center; margin-top: 10px; position:absolute; margin-left:120px; z-index: 10;">
                <button id="print-permit" onclick="generate_permit()" aria-label="Print" title="Print Permit">
                    <img src="image/permit_print_icon.png" alt="Print" style="width: 40px; height: 35px; vertical-align: middle; margin-left: 4px;">
                </button>
                <button class="submit-btn" onclick="submitForm()" aria-label="Save" title="Save">
                    <img src="image/save_icon.png" alt="Save" style="width: 35px; height: 30px; vertical-align: middle;">
                </button>
                <button id="printSaveBtn" onclick="generate_certificate()" aria-label="Print" title="Print Certificate">
                    <img src="image/certificate_print_icon.png" alt="Print" style="width: 35px; height: 30px; vertical-align: middle;">
                </button>
            </div>
    </div>
    <!-- Removed the Add Year button as per user request -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const businessName = urlParams.get('business_name');
            const ownerName = urlParams.get('owner_name');
            const applicantType = urlParams.get('applicant_type');
            const applicationYear = urlParams.get('application_year');
            const applicationDate = urlParams.get('application_date');

            if (businessName) {
                document.getElementById('businessName').value = decodeURIComponent(businessName);
            }
            if (ownerName) {
                document.getElementById('ownerName').value = decodeURIComponent(ownerName);
            }

            // Remove localStorage saving for category checkboxes

            // Fetch and prefill Classification and Sanitary Permit #
            if (businessName && ownerName) {
                try {
                    const response = await fetch(`http://localhost:3000/api/classifications?business_name=${encodeURIComponent(businessName)}&owner_name=${encodeURIComponent(ownerName)}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data) {
                            document.getElementById('classificationInput').value = data.classification || '';
                            document.getElementById('permitNumber').value = data.permit_number || '';
                            // Restore radio button selection from categories
                            if (data.categories && Array.isArray(data.categories)) {
                                document.getElementById('categoryFood').checked = data.categories.includes('Food');
                                document.getElementById('categoryNonFood').checked = data.categories.includes('Non-Food');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error fetching classification data:', error);
                }

            // Fetch and set permit status (remarks from owners table)
            if (businessName && ownerName) {
                try {
                    const ownerRes = await fetch(`http://localhost:3000/api/owners?business_name=${encodeURIComponent(businessName)}`);
                    if (ownerRes.ok) {
                        const owners = await ownerRes.json();
                        const ownerData = owners && owners.find(owner =>
                            owner.business_name.toUpperCase() === businessName.toUpperCase() &&
                            owner.owner_name.toUpperCase() === ownerName.toUpperCase()
                        );
                        if (ownerData && ownerData.remarks) {
                            document.getElementById('permitStatus').value = ownerData.remarks;
                        }
                    }
                } catch (error) {
                    console.error('Error fetching permit status:', error);
                }
            }

            // Fetch and populate employees data
            try {
                let fetchUrl = `http://localhost:3000/api/employees?business_name=${encodeURIComponent(businessName)}&owner_name=${encodeURIComponent(ownerName)}`;
                if (applicationYear) {
                    fetchUrl += `&year=${encodeURIComponent(applicationYear)}`;
                }

                const empResponse = await fetch(fetchUrl);
                if (empResponse.ok) {
                    let employees = await empResponse.json();

                    // Only duplicate for display if applicantType is Renewal and there are no employees for this year
                    if (applicantType === 'Renewal' && Array.isArray(employees) && employees.length === 0) {
                        // Fetch previous year's employees for display
                        const prevYear = applicationYear ? (parseInt(applicationYear) - 1).toString() : '';
                        if (prevYear) {
                            const prevEmpRes = await fetch(`http://localhost:3000/api/employees?business_name=${encodeURIComponent(businessName)}&owner_name=${encodeURIComponent(ownerName)}&year=${prevYear}`);
                            if (prevEmpRes.ok) {
                                const prevEmployees = await prevEmpRes.json();
                                employees = prevEmployees.map(emp => ({
                                    ...emp,
                                    id: null,
                                    application_date: applicationDate // set to current application_date for display
                                }));
                            }
                        }
                    }

                    if (Array.isArray(employees) && employees.length > 0) {
                        populateEmployeeTable(employees);
                    } 
                    
                    else {
                        // Clear table and add a single empty row with input boxes for new data entry
                        const tbody = document.getElementById("employeeTableBody2025");
                        tbody.innerHTML = `
                           <tr>
                    <td class="employee-no-cell">1</td>
                    <td><input type="text" class="employee-name" required></td>
                    <td><input type="text" class="employee-position" required></td>
                    <td><input type="number" class="employee-age" required></td>
                    <td><select class="employee-sex" required>
                        <option value="">Select Sex</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        </select></td>
                    <td><input type="text" class="employee-nationality" required></td>
                    <td><input type="text" class="employee-place-of-work" required></td>
                    <td><input type="text" class="employee-address" required></td>
                    <td><input type="text" class="health-cert" required></td>
                    <td><input type="text" class="remarks" required></td>
                    <td><input type="date" class="x-ray-date" required></td>
                    <td>
                        <button id="print-health-card" onclick="generate_health_cert()" aria-label="Print" title="Print Health Card">
                            <img src="image/health_card_print_icon.png" alt="Print" style="background: #0047abc9; border-radius: 50%; border:none; cursor:pointer; width: 24px; height: 24px; padding: 0; display: inline-flex; align-items: center; justify-content: center;">
                        </button>
                        <button onclick="addRow()" aria-label="Add" title="Add" style="background: #0047abc9; border-radius: 50%; border:none; cursor:pointer; width: 24px; height: 24px; padding: 0; display: inline-flex; align-items: center; justify-content: center;"
                            onmouseover="this.style.backgroundColor='#002e63'"
                            onmouseout="this.style.backgroundColor='#0047abc9'">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path fill="white" d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                                    </svg>
                        </button>
                        <button onclick="removeRow(this)" aria-label="Delete" title="Delete" style="background:  #ff4d4d; border-radius: 50%; border:none; cursor:pointer;  width: 24px; height: 24px; padding: 0; margin-left: 5px; display: inline-flex; align-items: center; justify-content: center;"
                            onmouseover="this.style.backgroundColor='#cc0000'"
                            onmouseout="this.style.backgroundColor='#ff4d4d'">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M5.5 5.5a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5zm5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5z"/>
                                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1 0-2h3.086a1 1 0 0 1 .707.293l.707.707h3.586l.707-.707A1 1 0 0 1 11.414 1H14.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118z"/>
                                </svg>
                        </button>
                        </td>
                    </tr>
                `;
                    }
                } 
                
                else {
                    console.error('Failed to fetch employees data. Status:', empResponse.status);
                    alert('Failed to fetch employees data from server.');
                }
            } 
            
            catch (error) {
                console.error('Error fetching employees data:', error);
                alert('Error fetching employees data. Please try again later.');
            }
            }
        });

        // Listen for changes to permitStatus and update DB
        document.addEventListener('DOMContentLoaded', () => {
            const permitStatusSelect = document.getElementById('permitStatus');
            permitStatusSelect.addEventListener('change', async function() {
                const status = this.value;
                const businessName = document.getElementById('businessName').value.trim();
                const ownerName = document.getElementById('ownerName').value.trim();
                if (!businessName || !ownerName) {
                    alert('Please enter both business name and owner name before changing status.');
                    this.value = '';
                    return;
                }
                try {
                    const response = await fetch('http://localhost:3000/api/owners/updateRemarks', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            business_name: businessName,
                            owner_name: ownerName,
                            remarks: status
                        })
                    });
                    if (!response.ok) {
                        alert('Failed to update status in database.');
                    }
                } catch (error) {
                    alert('Error updating status: ' + error.message);
                }
            });
        });

        async function removeRow(button) {
            const row = button.parentElement.parentElement;
            const employeeNoCell = row.querySelector('.employee-no-cell');
            const employeeNameInput = row.querySelector('.employee-name');
            const businessName = document.getElementById("businessName").value.trim();
            const ownerName = document.getElementById("ownerName").value.trim();

            // Check if this row has a data-employee-id attribute (existing employee)
            const employeeId = row.getAttribute('data-employee-id');

            if (employeeId) {
                // Confirm deletion
                if (!confirm(`Are you sure you want to delete employee "${employeeNameInput.value}"?`)) {
                    return;
                }
                try {
                    const response = await fetch(`http://localhost:3000/api/employees/${employeeId}`, {
                        method: 'DELETE',
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        alert(`Failed to delete employee: ${errorData.error || 'Unknown error'}`);
                        return;
                    }
                    alert('Employee deleted successfully');
                } catch (error) {
                    alert(`Error deleting employee: ${error.message}`);
                    return;
                }
            }

            // Remove row from DOM and update row numbers
            row.remove();
            updateRowNumbers();
        }

        function populateEmployeeTable(employees, unsavedRows = []) {
            // Determine visible table body
            let visibleTableBody = null;
            if (document.getElementById("table2025").style.display !== "none") {
                visibleTableBody = document.getElementById("employeeTableBody2025");
            } else if (document.getElementById("table2026").style.display !== "none") {
                visibleTableBody = document.getElementById("employeeTableBody2026");
            } else if (document.getElementById("table2027").style.display !== "none") {
                visibleTableBody = document.getElementById("employeeTableBody2027");
            } else {
                visibleTableBody = document.getElementById("employeeTableBody2025"); // default
            }

            // Clear existing rows
            visibleTableBody.innerHTML = '';

            // Populate rows from DB (saved)
            employees.forEach((emp, index) => {
                const tr = document.createElement('tr');
                // Set employee id as data attribute
                tr.setAttribute('data-employee-id', emp.id || '');

                // No.
                const tdNo = document.createElement('td');
                tdNo.className = 'employee-no-cell';
                tdNo.textContent = emp.no || (index + 1);
                tr.appendChild(tdNo);

                // Employee Name
                const tdName = document.createElement('td');
                const inputName = document.createElement('input');
                inputName.type = 'text';
                inputName.className = 'employee-name';
                inputName.value = emp.employee_name || '';
                tdName.appendChild(inputName);
                tr.appendChild(tdName);

                
                    // Position
                    const tdPosition = document.createElement('td');
                    const inputPosition = document.createElement('input');
                    inputPosition.type = 'text';
                    inputPosition.className = 'employee-position';
                    inputPosition.value = emp.position || '';
                    tdPosition.appendChild(inputPosition);
                    tr.appendChild(tdPosition);

                    // Age
                    const tdAge = document.createElement('td');
                    const inputAge = document.createElement('input');
                    inputAge.type = 'number';
                    inputAge.className = 'employee-age';
                    inputAge.value = emp.age || '';
                    tdAge.appendChild(inputAge);
                    tr.appendChild(tdAge);

                    // Sex
                    const tdSex = document.createElement('td');
                    const selectSex = document.createElement('select');
                    selectSex.className = 'employee-sex';
                    selectSex.required = true;
                    selectSex.innerHTML = `
                        <option value="">Select Sex</option>
                        <option value="Male" ${emp.sex === 'Male' ? 'selected' : ''}>Male</option>
                        <option value="Female" ${emp.sex === 'Female' ? 'selected' : ''}>Female</option>
                    `;
                    tdSex.appendChild(selectSex);
                    tr.appendChild(tdSex);

                    // Nationality
                    const tdNationality = document.createElement('td');
                    const inputNationality = document.createElement('input');
                    inputNationality.type = 'text';
                    inputNationality.className = 'employee-nationality';
                    inputNationality.value = emp.nationality || '';
                    tdNationality.appendChild(inputNationality);
                    tr.appendChild(tdNationality);

                    // Place of Work
                    const tdPlaceOfWork = document.createElement('td');
                    const inputPlaceOfWork = document.createElement('input');
                    inputPlaceOfWork.type = 'text';
                    inputPlaceOfWork.className = 'employee-place-of-work';
                    inputPlaceOfWork.value = emp.place_of_work || '';
                    tdPlaceOfWork.appendChild(inputPlaceOfWork);
                    tr.appendChild(tdPlaceOfWork);


                // Address
                const tdAddress = document.createElement('td');
                const inputAddress = document.createElement('input');
                inputAddress.type = 'text';
                inputAddress.className = 'employee-address';
                inputAddress.value = emp.address || '';
                tdAddress.appendChild(inputAddress);
                tr.appendChild(tdAddress);

                // Health Cert No.
                const tdCert = document.createElement('td');
                const inputCert = document.createElement('input');
                inputCert.type = 'text';
                inputCert.className = 'health-cert';
                // Remove auto-assignment and readOnly
                inputCert.value = emp.health_cert_no || '';
                tdCert.appendChild(inputCert);
                tr.appendChild(tdCert);

                // Remarks
                const tdRemarks = document.createElement('td');
                const inputRemarks = document.createElement('input');
                inputRemarks.type = 'text';
                inputRemarks.className = 'remarks';
                inputRemarks.value = emp.remarks || '';
                tdRemarks.appendChild(inputRemarks);
                tr.appendChild(tdRemarks);

                // Date of X-ray
                const tdXray = document.createElement('td');
                const inputXray = document.createElement('input');
                inputXray.type = 'date';
                inputXray.className = 'x-ray-date';
                if (emp.date_of_xray) {
                    inputXray.value = emp.date_of_xray.split('T')[0];
                }
                tdXray.appendChild(inputXray);
                tr.appendChild(tdXray);

                // Actions
                const tdActions = document.createElement('td');
                tdActions.innerHTML = `
                    <button id="print-health-card" onclick="generate_health_cert()" aria-label="Print" title="Print Health Card">
                        <img src="image/health_card_print_icon.png" alt="Print" style="background: #0047abc9; border-radius: 50%; border:none; cursor:pointer; width: 24px; height: 24px; padding: 0; display: inline-flex; align-items: center; justify-content: center;">
                    </button>
                    <button onclick="addRow()" aria-label="Add" title="Add" style="background: #0047abc9; border-radius: 50%; border:none; cursor:pointer; width: 24px; height: 24px; padding: 0; display: inline-flex; align-items: center; justify-content: center;"
                        onmouseover="this.style.backgroundColor='#002e63'"
                        onmouseout="this.style.backgroundColor='#0047abc9'">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path fill="white" d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                    </button>
                    <button onclick="removeRow(this)" aria-label="Delete" title="Delete" style="background: #ff4d4d; border-radius: 50%; border:none; cursor:pointer; width: 24px; height: 24px; padding: 0; margin-left: 5px; display: inline-flex; align-items: center; justify-content: center;"
                        onmouseover="this.style.backgroundColor='#cc0000'"
                        onmouseout="this.style.backgroundColor='#ff4d4d'">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M5.5 5.5a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5zm5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5z"/>
                                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1 0-2h3.086a1 1 0 0 1 .707.293l.707.707h3.586l.707-.707A1 1 0 0 1 11.414 1H14.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118z"/>
                            </svg>
                    </button>
                `;
                tr.appendChild(tdActions);

                visibleTableBody.appendChild(tr);
            });

            // Append unsaved/new rows (if any)
            unsavedRows.forEach((rowData, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                
                        <td class="employee-no-cell"></td>
                        <td><input type="text" class="employee-name" required value="${rowData.name || ''}"></td>
                        <td><input type="text" class="employee-position" required value="${rowData.position || ''}"></td>
                        <td><input type="number" class="employee-age" required value="${rowData.age || ''}"></td>
                        <td><select class="employee-sex" required>
                            <option value="">Select Sex</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            </select></td>
                        <td><input type="text" class="employee-nationality" required value="${rowData.nationality || ''}"></td>
                        <td><input type="text" class="employee-place-of-work" required value="${rowData.place_of_work || ''}"></td>
                        <td><input type="text" class="employee-address" required value="${rowData.address || ''}"></td>
                        <td><input type="text" class="health-cert" required></td>
                        <td><input type="text" class="remarks" required value="${rowData.remarks || ''}"></td>
                        <td><input type="date" class="x-ray-date" required value="${rowData.date_of_xray || ''}"></td>
                    <td>
            `;
                visibleTableBody.appendChild(tr);
            });

            // If no rows at all, add a blank row
            if (employees.length === 0 && unsavedRows.length === 0) {
                addRow();
            }

            updateRowNumbers();
        }

        function updateRowNumbers() {
            const visibleTable = document.querySelector(".table-container table:not([style*='display: none'])");
            if (!visibleTable) return;
            const rows = visibleTable.querySelectorAll("tbody tr");
            rows.forEach((row, index) => {
                const noCell = row.querySelector(".employee-no-cell");
                if (noCell) {
                    noCell.textContent = index + 1;
                }
            });
        }

        async function submitForm() {
            let businessName = document.getElementById("businessName").value.trim();
            let ownerName = document.getElementById("ownerName").value.trim();
            let permitNumber = document.getElementById("permitNumber").value.trim();
            let classification = document.getElementById("classificationInput").value.trim();
            const classificationId = document.getElementById("classificationId").value;

            // Send empty strings if the fields are empty
            permitNumber = permitNumber || "";
            classification = classification || "";

            // Validate required inputs in employee table
            const visibleTableBody = document.querySelector(".table-container table:not([style*='display: none']) tbody");
            if (visibleTableBody) {
                const inputs = visibleTableBody.querySelectorAll("input[required]");
                for (const input of inputs) {
                    if (!input.value.trim()) {
                        alert("Please input all the required fields in the employee table.");
                        input.focus();
                        return;
                    }
                }
            }

            // Save Sanitary Permit # and Classification with selected categories as linkable_texts
            const selectedCategories = [];
            if (document.getElementById("categoryFood").checked) selectedCategories.push("Food");
            if (document.getElementById("categoryNonFood").checked) selectedCategories.push("Non-Food");

            try {
                const response = await fetch('http://localhost:3000/api/classifications/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        id: classificationId,
                        businessName, 
                        ownerName, 
                        permitNumber, 
                        classification, 
                        linkable_texts: selectedCategories 
                    }),
                });

                if (!response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to save Sanitary Permit # and Classification');
                    } else {
                        const errorText = await response.text();
                        console.error('Unexpected response:', errorText);
                        throw new Error('Unexpected response from server');
                    }
                }

                alert('Saved successfully!');
                // Save selected categories in localStorage to persist checkbox state
                localStorage.setItem('selectedCategories', JSON.stringify(selectedCategories));
                // Proceed with saving employees
                await saveEmployees();

                // Refetch classification data to update input fields
                await fetchClassificationData(businessName, ownerName);

            } catch (error) {
                console.error('Error saving Sanitary Permit # and Classification:', error);
                alert(`Failed to save Sanitary Permit # and Classification: ${error.message}`);
            }
        }

        async function fetchClassificationData(businessName, ownerName) {
            try {
                const response = await fetch(`http://localhost:3000/api/classifications?business_name=${encodeURIComponent(businessName)}&owner_name=${encodeURIComponent(ownerName)}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data) {
                        document.getElementById('classificationInput').value = data.classification || '';
                        document.getElementById('permitNumber').value = data.permit_number || '';
                        document.getElementById('classificationId').value = data.id || ''; // Store the ID
                        // Restore radio button selection from categories
                        if (data.categories && Array.isArray(data.categories)) {
                            document.getElementById('categoryFood').checked = data.categories.includes('Food');
                            document.getElementById('categoryNonFood').checked = data.categories.includes('Non-Food');
                        }
                    }
                }
            } catch (error) {
                console.error('Error fetching classification data:', error);
            }
        }

        async function saveEmployees() {
            const businessName = document.getElementById("businessName").value.trim();
            const ownerName = document.getElementById("ownerName").value.trim();
            const categoryFood = document.getElementById("categoryFood").checked;
            const categoryNonFood = document.getElementById("categoryNonFood").checked;
            const categories = [];
            if (categoryFood) categories.push("Food");
            if (categoryNonFood) categories.push("Non-Food");

            const urlParams = new URLSearchParams(window.location.search);
            const applicationYear = urlParams.get('application_year');
            let applicationDate = urlParams.get('application_date');
            // Always use the correct applicationDate for saving
            if (applicationYear) {
                applicationDate = `${applicationYear}-01-01`;
            }

            let visibleTableBody = null;
            const table2025 = document.getElementById("table2025");
            const table2026 = document.getElementById("table2026");
            const table2027 = document.getElementById("table2027");

            if (table2025 && table2025.offsetParent !== null) {
                visibleTableBody = document.getElementById("employeeTableBody2025");
            } else if (table2026 && table2026.offsetParent !== null) {
                visibleTableBody = document.getElementById("employeeTableBody2026");
            } else if (table2027 && table2027.offsetParent !== null) {
                visibleTableBody = document.getElementById("employeeTableBody2027");
            } else {
                visibleTableBody = document.getElementById("employeeTableBody2025");
            }

            if (!visibleTableBody) {
                alert('No employee table is visible. Cannot save employees.');
                return;
            }

            // Validate required inputs in employee table before saving
            const inputs = visibleTableBody.querySelectorAll("input[required]");
            for (const input of inputs) {
                if (!input.value.trim()) {
                    alert("Please input all the required fields in the employee table.");
                    input.focus();
                    return;
                }
            }

            // Gather all rows (including unsaved/new)
            const employees = [];
            visibleTableBody.querySelectorAll("tr").forEach(row => {
                const id = row.getAttribute('data-employee-id') || null;
                const noText = row.querySelector(".employee-no-cell")?.textContent.trim() || '';
                const no = noText ? parseInt(noText, 10) : null;
                const name = row.querySelector(".employee-name")?.value.trim() || '';
                const position = row.querySelector(".employee-position")?.value.trim() || '';
                const age = row.querySelector(".employee-age")?.value.trim() || '';
                const sex = row.querySelector(".employee-sex")?.value.trim() || '';
                const nationality= row.querySelector(".employee-nationality")?.value.trim() || '';
                const place_of_work = row.querySelector(".employee-place-of-work")?.value.trim() || '';
                const address = row.querySelector(".employee-address")?.value.trim() || '';
                const cert = row.querySelector(".health-cert")?.value.trim() || '';
                const remarks = row.querySelector(".remarks")?.value.trim() || '';
                let date_of_xray = row.querySelector(".x-ray-date")?.value || '';
                if (date_of_xray === "") date_of_xray = null;
                // Only push if at least one field is filled
                if (name || address || cert || remarks || date_of_xray) {
                    employees.push({
                       id,
                        business_name: businessName,
                        owner_name: ownerName,
                        no,
                        name,
                        position,
                        age,
                        sex,
                        nationality,
                        place_of_work,
                        address,
                        cert,
                        remarks,
                        date_of_xray,
                        application_date: applicationDate // always set correct application_date
                    });
                }
            });

            const formData = { businessName, ownerName, categories, employees };

            try {
                const response = await fetch('http://localhost:3000/api/employees/full', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to save employees. Status: ${response.status}. Response: ${errorText}`);
                }

                alert('Employees saved successfully!');
                // After saving, reload all employees using only backend data (no unsaved rows)
                await reloadEmployeesTableOnlyFromBackend(businessName, ownerName, visibleTableBody);
            } catch (error) {
                console.error('Error saving employees:', error);
                alert(`Failed to save employees: ${error.message}`);
            }
        }

        async function reloadEmployeesTableOnlyFromBackend(businessName, ownerName, visibleTableBody) {
            try {
                const empResponse = await fetch(`http://localhost:3000/api/employees?business_name=${encodeURIComponent(businessName)}&owner_name=${encodeURIComponent(ownerName)}`);
                let employees = [];
                if (empResponse.ok) {
                    employees = await empResponse.json();
                }
                populateEmployeeTable(employees, []); // do not append unsaved rows
            } catch (error) {
                console.error('Error fetching employees data:', error);
                alert('Error fetching employees data. Please try again later.');
            }
        }

        // Utility to get the current year or application year from URL
        function getCurrentYearForCert() {
            const urlParams = new URLSearchParams(window.location.search);
            const applicationYear = urlParams.get('application_year');
            if (applicationYear && /^\d{4}$/.test(applicationYear)) {
                return applicationYear;
            }
            return new Date().getFullYear().toString();
        }

        // Generate health cert number for a given row index (starting from 0)
        function getHealthCertNoByIndex(index) {
            const year = getCurrentYearForCert();
            return `${year}-${(index + 1).toString().padStart(4, '0')}`;
        }

        // Update all health-cert numbers in the visible table to match their row order
        function updateHealthCertNumbers() {
            const tableBody = document.querySelector(".table-container table:not([style*='display: none']) tbody");
            if (!tableBody) return;
            const rows = Array.from(tableBody.querySelectorAll("tr"));
            rows.forEach((row, idx) => {
                const certInput = row.querySelector('.health-cert');
                if (certInput) {
                    certInput.value = getHealthCertNoByIndex(idx);
                    certInput.readOnly = true;
                }
            });
        }

        // When adding a row, auto-assign the health-cert number
        function addRow() {
            const tableBody = document.querySelector(".table-container table:not([style*='display: none']) tbody");
            if (!tableBody) return;

            const newRow = document.createElement("tr");
            newRow.innerHTML = `
                <td class="employee-no-cell"></td>
                <td><input type="text" class="employee-name" required></td>
                <td><input type="text" class="employee-position" required></td>
                <td><input type="number" class="employee-age" required></td>
                <td><select class="employee-sex" required>
                    <option value="">Select Sex</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    </select></td>
                <td><input type="text" class="employee-nationality" required></td>
                <td><input type="text" class="employee-place-of-work" required></td>
                <td><input type="text" class="employee-address" required></td>
                <td><input type="text" class="health-cert" required></td> <!-- Editable, no value -->
                <td><input type="text" class="remarks" required></td>
                <td><input type="date" class="x-ray-date" required></td>
                <td>
                    <button id="print-health-card" onclick="generate_health_cert()" aria-label="Print" title="Print Health Card">
                        <img src="image/health_card_print_icon.png" alt="Print" style="background: #0047abc9; border-radius: 50%; border:none; cursor:pointer; width: 24px; height: 24px; padding: 0; display: inline-flex; align-items: center; justify-content: center;">
                    </button>
                    <button onclick="addRow()" aria-label="Add" title="Add" style="background: #0047abc9; border-radius: 50%; border:none; cursor:pointer; width: 24px; height: 24px; padding: 0; display: inline-flex; align-items: center; justify-content: center;"
                        onmouseover="this.style.backgroundColor='#002e63'"
                        onmouseout="this.style.backgroundColor='#0047abc9'">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path fill="white" d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                    </button>
                    <button onclick="removeRow(this)" aria-label="Delete" title="Delete" style="background:  #ff4d4d; border-radius: 50%; border:none; cursor:pointer;  width: 24px; height: 24px; padding: 0; margin-left: 5px; display: inline-flex; align-items: center; justify-content: center;"
                        onmouseover="this.style.backgroundColor='#cc0000'"
                        onmouseout="this.style.backgroundColor='#ff4d4d'">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M5.5 5.5a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5zm5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0v-6a.5.5 0 0 1 .5-.5z"/>
                                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1 0-2h3.086a1 1 0 0 1 .707.293l.707.707h3.586l.707-.707A1 1 0 0 1 11.414 1H14.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118z"/>
                            </svg>
                    </button>
                </td>
            `;
            tableBody.appendChild(newRow);
            updateRowNumbers();
        }

        // On initial page load, do NOT auto-assign health-cert number
        document.addEventListener('DOMContentLoaded', () => {
            // updateHealthCertNumbers(); // REMOVE THIS LINE
            // Ensure the first row (if present) gets its health-cert number immediately
            const tableBody = document.querySelector(".table-container table:not([style*='display: none']) tbody");
            if (tableBody) {
                const rows = Array.from(tableBody.querySelectorAll("tr"));
                if (rows.length === 1) {
                    const certInput = rows[0].querySelector('.health-cert');
                    if (certInput && !certInput.value) {
                        certInput.value = getHealthCertNoByIndex(0);
                        certInput.readOnly = true;
                    }
                }
            }
        });

        async function generate_permit() {
            // Check permit status before proceeding
            const permitStatus = document.getElementById('permitStatus').value;
            if (permitStatus !== "Issued") {
                alert('Permit can only be generated if status is "Issued".');
                return;
            }
            const urlParams = new URLSearchParams(window.location.search);
            let businessName = urlParams.get('business_name');
            let ownerName = urlParams.get('owner_name');

            if (!businessName) {
                businessName = document.getElementById('businessName').value.trim();
                if (!businessName) {
                    alert('Please enter or select a business name.');
                    return;
                }
            } else {
                businessName = decodeURIComponent(businessName); // Decode if it comes from URL
            }

            if (!ownerName) {
                ownerName = document.getElementById('ownerName').value.trim();
                 if (!ownerName) {
                    alert('Please enter owner name.');
                    return;
                }
            } else {
                ownerName = decodeURIComponent(ownerName); // Decode if it comes from URL
            }

            try {
                // Owner and address info
                const ownerRes = await fetch(`http://localhost:3000/api/owners?business_name=${encodeURIComponent(businessName)}`);
                if (!ownerRes.ok) throw new Error('Failed to fetch owner info');
                const owners = await ownerRes.json();
                
                // Filter owners array to find the entry matching both businessName, ownerName, and application_date
                let applicationDateParam = urlParams.get('application_date');
                let ownerData;
                if (applicationDateParam) {
                    // If application_date is provided in URL, use it for precise match
                    ownerData = owners && owners.find(owner => 
                        owner.business_name.toUpperCase() === businessName.toUpperCase() && 
                        owner.owner_name.toUpperCase() === ownerName.toUpperCase() &&
                        owner.application_date && owner.application_date.startsWith(applicationDateParam)
                    );
                } else {
                    // Fallback: match only businessName and ownerName
                    ownerData = owners && owners.find(owner => 
                        owner.business_name.toUpperCase() === businessName.toUpperCase() && 
                        owner.owner_name.toUpperCase() === ownerName.toUpperCase()
                    );
                }

                if (!ownerData) {
                    alert('No matching owner found for the given Business Name and Owner Name.');
                    return;
                }

                // Classification and permit number
                const classificationUrl = `http://localhost:3000/api/classifications?business_name=${encodeURIComponent(businessName)}&owner_name=${encodeURIComponent(ownerName)}`;
                console.log('Fetching classification data from:', classificationUrl); // Log the URL
                const classRes = await fetch(classificationUrl);
                if (!classRes.ok) {
                    console.error('Classification fetch failed with status:', classRes.status);
                    throw new Error(`Failed to fetch classification info. Status: ${classRes.status}`);
                }
                const classData = await classRes.json();

                // Fetch employee count
                let employeeCountUrl = `http://localhost:3000/api/employees?business_name=${encodeURIComponent(businessName)}&owner_name=${encodeURIComponent(ownerName)}`;
                const applicationYear = urlParams.get('application_year');
                if (applicationYear) {
                    employeeCountUrl += `&year=${encodeURIComponent(applicationYear)}`;
                }
                const employeeRes = await fetch(employeeCountUrl);
                if (!employeeRes.ok) {
                    console.error('Employee fetch failed with status:', employeeRes.status);
                    throw new Error(`Failed to fetch employee info. Status: ${employeeRes.status}`);
                }
                const employees = await employeeRes.json();
                const employeeCount = employees.length;

                const ownerNameFromData = ownerData.owner_name ? ownerData.owner_name.toUpperCase() : '';
                const address = ownerData.address || '';
                const permitNumber = classData.permit_number || '';
                const classification = classData.classification || '';

                if (!ownerNameFromData || !permitNumber || !classification) {
                    alert('Some required data is missing from the database.');
                    return;
                }

                // Calculate expiration date (December 31 of the current year)
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const expirationDate = `December 31, ${currentYear}`;

                // Get application date and format it
                const rawApplicationDate = ownerData.application_date;
                let applicationDate = 'Not Available';
                if (rawApplicationDate) {
                    const date = new Date(rawApplicationDate);
                    const month = date.toLocaleString('default', { month: 'long' }); // Full month name
                    const day = date.getDate();
                    const year = date.getFullYear();
                    applicationDate = `${month} ${day}, ${year}`;
                }

                // Get date_issued and format it for the docx
                let dateIssued = '';
                if (ownerData.date_issued) {
                    const date = new Date(ownerData.date_issued);
                    const month = date.toLocaleString('default', { month: 'long' });
                    const day = date.getDate();
                    const year = date.getFullYear();
                    dateIssued = `${month} ${day}, ${year}`;
                } else {
                    dateIssued = '';
                }

                // Construct the URL for the API endpoint, pass dateIssued as Date_Issued
                const url = `http://localhost:3000/api/generatePermit?businessName=${encodeURIComponent(businessName)}&ownerName=${encodeURIComponent(ownerName)}&classification=${encodeURIComponent(classification)}&address=${encodeURIComponent(address)}&permitNumber=${encodeURIComponent(permitNumber)}&applicationDate=${encodeURIComponent(applicationDate)}&employeeCount=${encodeURIComponent(employeeCount)}&expirationDate=${encodeURIComponent(expirationDate)}&dateIssued=${encodeURIComponent(dateIssued)}`;

                // Open a new window to trigger the download
                window.open(url, '_blank');
                
            } catch (error) {
                alert('Error fetching permit data: ' + error.message);
            }
        }

        async function generate_certificate() {
            // Check permit status before proceeding
            const permitStatus = document.getElementById('permitStatus').value;
            if (permitStatus !== "Issued") {
                alert('Certificate can only be generated if status is "Issued".');
                return;
            }
            const businessName = document.getElementById('businessName').value.trim();
            const ownerName = document.getElementById('ownerName').value.trim();

            if (!businessName || !ownerName) {
                alert('Please enter both business name and owner name.');
                return;
            }

            try {
                // Fetch owner info to get application_date
                const ownerRes = await fetch(`http://localhost:3000/api/owners?business_name=${encodeURIComponent(businessName)}`);
                if (!ownerRes.ok) throw new Error('Failed to fetch owner info');
                const owners = await ownerRes.json();

                // Find the owner matching both businessName and ownerName
                const ownerData = owners && owners.find(owner =>
                    owner.business_name.toUpperCase() === businessName.toUpperCase() &&
                    owner.owner_name.toUpperCase() === ownerName.toUpperCase()
                );

                if (!ownerData) {
                    alert('No matching owner found for the given Business Name and Owner Name.');
                    return;
                }

                // Extract application year from application_date
                let applicationYear = null;
                if (ownerData.application_date) {
                    applicationYear = new Date(ownerData.application_date).getFullYear();
                }

                // Construct the URL for the API endpoint with applicationYear
                let url = `http://localhost:3000/api/generateCertificate?businessName=${encodeURIComponent(businessName)}&ownerName=${encodeURIComponent(ownerName)}`;
                if (applicationYear) {
                    url += `&year=${encodeURIComponent(applicationYear)}`;
                }

                // Open a new window to trigger the download
                window.open(url, '_blank');

            } catch (error) {
                alert('Error fetching owner data: ' + error.message);
            }
        }

        async function generate_health_cert() {
            // Check permit status before proceeding
            const permitStatus = document.getElementById('permitStatus').value;
            if (permitStatus !== "Issued") {
                alert('Health Card can only be generated if status is "Issued".');
                return;
            }
            // Find the button that triggered the event
            const event = window.event;
            if (!event) return;
            const button = event.target.closest('button');
            if (!button) return;
            const row = button.closest('tr');
            if (!row) return;

            // Fetch the required fields from the row
            const healthCertNo = row.querySelector('.health-cert')?.value || '';
            const employeeName = row.querySelector('.employee-name')?.value || '';
            const position = row.querySelector('.employee-position')?.value || '';
            const age = row.querySelector('.employee-age')?.value || '';
            const sex = row.querySelector('.employee-sex')?.value || '';
            const nationality = row.querySelector('.employee-nationality')?.value || '';
            const businessName = document.getElementById('businessName')?.value || '';

            // Build the API URL with query parameters (include business_name)
            const params = new URLSearchParams({
                health_cert_no: healthCertNo,
                employee_name: employeeName,
                position: position,
                age: age,
                sex: sex,
                nationality: nationality,
                business_name: businessName
            });

            // Open the generated docx in a new tab (triggers download)
            window.open(`http://localhost:3000/api/generateHealthCard?${params.toString()}`, '_blank');
        }
    </script>
<!-- <script src="print.js"></script> -->
</body>
</html>
